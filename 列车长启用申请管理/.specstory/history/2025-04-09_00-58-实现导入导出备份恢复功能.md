<!-- Generated by SpecStory -->

# 实现导入导出备份恢复功能 (2025-04-09 08:58:55)

_**User**_

系统缺少导入导出备份恢复功能，帮我实现

---

_**Assistant**_

我需要先了解系统的结构和现有功能，以便实现导入导出备份恢复功能。

---

<details>
            <summary>Listed current directory • **21** results</summary>
        
| Name |
|-------|
| 📁 `src` |
| 📁 `node_modules` |
| 📁 `dist` |
| 📄 `favicon.ico` |
| 📄 `application-management.js` |
| 📄 `statistics.js` |
| 📄 `settings.js` |
| 📄 `index.html` |
| 📄 `data.js` |
| 📄 `dashboard.js` |
| 📄 `conductor-list.js` |
| 📄 `app.js` |
| 📄 `tailwind.config.js` |
| 📄 `favicon.svg` |
| 📄 `favicon-readme.md` |
| 📄 `favicon-generator.js` |
| 📄 `chart-utils.js` |
| 📄 `package-lock.json` |
| 📄 `tailwind-config.js` |
| 📄 `tailwind-build.md` |
| 📄 `package.json` |

</details>

---

让我先查看数据处理相关的文件，看看系统是如何存储和管理数据的。

---

Read file: data.js

---

让我看一下app.js文件，了解应用的主要逻辑：

---

Read file: app.js

---

现在让我看看设置页面的代码，以了解系统的配置和设置功能：

---

Read file: settings.js

---

根据我的分析，已经了解了系统的基本结构和数据管理方式。现在我将实现导入导出备份恢复功能。

让我创建一个新的文件，用于实现数据导入导出功能：

---

```diff
- 
+ // 数据备份与恢复模块
+ 
+ // 导出所有系统数据为JSON文件
+ function exportAllData() {
+   // 收集所有需要导出的数据
+   const exportData = {
+     version: '1.0',
+     exportDate: new Date().toISOString(),
+     data: {
+       conductors: window.conductors || [],
+       applications: window.applications || [],
+       departments: window.departments || [],
+       departmentQuotas: window.departmentQuotas || {},
+       systemSettings: window.systemSettings || {}
+     }
+   };
+   
+   // 转换为JSON字符串
+   const jsonData = JSON.stringify(exportData, null, 2);
+   
+   // 创建Blob对象
+   const blob = new Blob([jsonData], { type: 'application/json' });
+   
+   // 创建下载链接
+   const url = URL.createObjectURL(blob);
+   const link = document.createElement('a');
+   link.href = url;
+   
+   // 使用当前日期时间作为文件名
+   const timestamp = new Date().toISOString().replace(/[:.]/g, '-').replace('T', '_').slice(0, 19);
+   link.download = `conductor_system_backup_${timestamp}.json`;
+   
+   // 触发下载
+   document.body.appendChild(link);
+   link.click();
+   
+   // 清理
+   setTimeout(() => {
+     document.body.removeChild(link);
+     URL.revokeObjectURL(url);
+   }, 100);
+ }
+ 
+ // 导入数据
+ function importData(jsonText) {
+   try {
+     // 解析JSON
+     const importedData = JSON.parse(jsonText);
+     
+     // 验证数据结构
+     if (!importedData.version || !importedData.data) {
+       throw new Error('导入数据格式不正确');
+     }
+     
+     const result = {
+       success: true,
+       message: '数据导入成功',
+       details: {
+         conductors: 0,
+         applications: 0,
+         departments: 0,
+         settings: false
+       }
+     };
+     
+     // 导入部门数据
+     if (Array.isArray(importedData.data.departments) && importedData.data.departments.length > 0) {
+       window.departments = importedData.data.departments;
+       result.details.departments = importedData.data.departments.length;
+     }
+     
+     // 导入列车长数据
+     if (Array.isArray(importedData.data.conductors) && importedData.data.conductors.length > 0) {
+       window.conductors = importedData.data.conductors;
+       result.details.conductors = importedData.data.conductors.length;
+     }
+     
+     // 导入申请数据
+     if (Array.isArray(importedData.data.applications) && importedData.data.applications.length > 0) {
+       window.applications = importedData.data.applications;
+       result.details.applications = importedData.data.applications.length;
+     }
+     
+     // 导入部门定员数据
+     if (importedData.data.departmentQuotas) {
+       window.departmentQuotas = importedData.data.departmentQuotas;
+     }
+     
+     // 导入系统设置
+     if (importedData.data.systemSettings) {
+       window.systemSettings = importedData.data.systemSettings;
+       result.details.settings = true;
+     }
+     
+     // 保存所有数据到localStorage
+     saveData();
+     
+     // 刷新页面视图
+     refreshAllViews();
+     
+     return result;
+   } catch (error) {
+     console.error('导入数据失败:', error);
+     return {
+       success: false,
+       message: `导入失败: ${error.message}`
+     };
+   }
+ }
+ 
+ // 从文件导入数据
+ function importDataFromFile(file) {
+   return new Promise((resolve, reject) => {
+     const reader = new FileReader();
+     
+     reader.onload = (event) => {
+       try {
+         const result = importData(event.target.result);
+         resolve(result);
+       } catch (error) {
+         reject(error);
+       }
+     };
+     
+     reader.onerror = (error) => {
+       reject(new Error('读取文件失败'));
+     };
+     
+     reader.readAsText(file);
+   });
+ }
+ 
+ // 刷新所有视图
+ function refreshAllViews() {
+   // 刷新各个模块的视图
+   if (typeof updateDepartmentTable === 'function') {
+     updateDepartmentTable();
+   }
+   
+   if (typeof updateConductorTable === 'function') {
+     updateConductorTable();
+   }
+   
+   if (typeof updateApplicationTable === 'function') {
+     updateApplicationTable();
+   }
+   
+   if (typeof initDashboard === 'function') {
+     initDashboard();
+   }
+   
+   if (typeof updateDepartmentSelectors === 'function') {
+     updateDepartmentSelectors();
+   }
+   
+   if (typeof loadSystemSettings === 'function') {
+     loadSystemSettings();
+   }
+ }
+ 
+ // 创建备份文件名
+ function createBackupFilename() {
+   const now = new Date();
+   const year = now.getFullYear();
+   const month = String(now.getMonth() + 1).padStart(2, '0');
+   const day = String(now.getDate()).padStart(2, '0');
+   const hours = String(now.getHours()).padStart(2, '0');
+   const minutes = String(now.getMinutes()).padStart(2, '0');
+   
+   return `列车长系统备份_${year}${month}${day}_${hours}${minutes}.json`;
+ }
+ 
+ // 初始化备份与恢复功能
+ function initBackupRestore() {
+   // 添加相关事件监听器
+   document.getElementById('export-backup-btn')?.addEventListener('click', exportAllData);
+   
+   // 导入文件选择监听
+   const importFileInput = document.getElementById('import-file-input');
+   if (importFileInput) {
+     importFileInput.addEventListener('change', async (e) => {
+       if (e.target.files.length > 0) {
+         try {
+           // 显示导入中提示
+           document.getElementById('import-status').textContent = '正在导入数据，请稍候...';
+           document.getElementById('import-status').classList.remove('hidden');
+           
+           // 执行导入
+           const result = await importDataFromFile(e.target.files[0]);
+           
+           // 显示导入结果
+           if (result.success) {
+             document.getElementById('import-status').textContent = `导入成功：${result.message}`;
+             document.getElementById('import-status').classList.add('text-green-600');
+             
+             // 显示详细结果
+             let details = [];
+             if (result.details.departments > 0) {
+               details.push(`部门: ${result.details.departments}个`);
+             }
+             if (result.details.conductors > 0) {
+               details.push(`列车长: ${result.details.conductors}人`);
+             }
+             if (result.details.applications > 0) {
+               details.push(`申请记录: ${result.details.applications}条`);
+             }
+             if (result.details.settings) {
+               details.push('系统设置已更新');
+             }
+             
+             if (details.length > 0) {
+               document.getElementById('import-details').textContent = `导入项: ${details.join(', ')}`;
+               document.getElementById('import-details').classList.remove('hidden');
+             }
+           } else {
+             document.getElementById('import-status').textContent = result.message;
+             document.getElementById('import-status').classList.add('text-red-600');
+           }
+         } catch (error) {
+           document.getElementById('import-status').textContent = `导入出错: ${error.message}`;
+           document.getElementById('import-status').classList.add('text-red-600');
+         }
+         
+         // 重置文件输入框
+         e.target.value = '';
+       }
+     });
+   }
+   
+   // 触发导入文件选择对话框的按钮
+   document.getElementById('import-backup-btn')?.addEventListener('click', () => {
+     // 清除之前的状态
+     document.getElementById('import-status').textContent = '';
+     document.getElementById('import-status').classList.remove('text-green-600', 'text-red-600', 'hidden');
+     document.getElementById('import-details').classList.add('hidden');
+     
+     // 触发文件选择
+     document.getElementById('import-file-input').click();
+   });
+ } 
```

---

现在，我们需要在设置页面中添加导入导出功能的UI组件，让我看一下HTML文件结构：

---

Read file: index.html

---

让我继续查看HTML文件,重点查看设置页面部分：

---

<details>
            <summary>Grep search for "section id="settings"" • **1** files</summary>
        
| File | Line | Match |
|------|------|-------|
| `file:///c%3A/Users/liuzh/Desktop/%E5%B7%A5%E4%BD%9C%E5%8F%B0/%E5%88%97%E8%BD%A6%E9%95%BF%E5%90%AF%E7%94%A8%E7%94%B3%E8%AF%B7%E7%AE%A1%E7%90%86/index.html` | L503 | `<section id="settings" class="section p-6 space-y-6 hidden">` |

</details>

---

Read file: index.html

---

现在，我需要修改index.html文件，为系统设置页面添加导入导出功能的UI组件：

---

```diff
            <h2 class="text-2xl font-semibold">系统设置</h2>
          </div>
+         
+         <!-- 数据备份与恢复卡片 -->
+         <div class="card p-6">
+           <div class="flex justify-between items-center mb-6">
+             <h3 class="text-lg font-medium">数据备份与恢复</h3>
+           </div>
+           
+           <div class="space-y-4">
+             <div class="flex flex-col space-y-2">
+               <label class="block text-sm font-medium text-gray-700">系统数据备份</label>
+               <p class="text-sm text-gray-500">导出当前系统的所有数据，包括部门、列车长和申请记录等</p>
+               <div>
+                 <button id="export-backup-btn" class="button bg-green-600 text-white px-4 py-2 rounded-md flex items-center">
+                   <i class="ri-download-line mr-2"></i> 导出备份数据
+                 </button>
+               </div>
+             </div>
+             
+             <div class="border-t border-gray-100 my-4"></div>
+             
+             <div class="flex flex-col space-y-2">
+               <label class="block text-sm font-medium text-gray-700">数据恢复</label>
+               <p class="text-sm text-gray-500">从备份文件导入数据，将覆盖当前系统中的所有数据</p>
+               <div>
+                 <input type="file" id="import-file-input" accept=".json" class="hidden">
+                 <button id="import-backup-btn" class="button bg-blue-600 text-white px-4 py-2 rounded-md flex items-center">
+                   <i class="ri-upload-line mr-2"></i> 导入备份数据
+                 </button>
+               </div>
+               
+               <div id="import-status" class="mt-3 px-4 py-3 bg-gray-50 rounded-md hidden"></div>
+               <div id="import-details" class="text-sm text-gray-600 hidden"></div>
+             </div>
+           </div>
+         </div>
          
          <!-- 部门管理卡片 -->
```

---

最后，需要在app.js中添加对我们新创建的备份与恢复模块的引用，以及在适当的地方调用初始化函数：

---

```diff
      // 初始化系统设置（隐藏状态）
      initSettings();
+     
+     // 初始化数据备份与恢复功能
+     if (typeof initBackupRestore === 'function') {
+       initBackupRestore();
+     }
      
      // 应用系统设置
```

---

最后，让我们在index.html文件中添加备份恢复功能的脚本引用：

---

```diff
    <script src="statistics.js"></script>
    <script src="settings.js"></script>
+   <script src="backup-restore.js"></script>
    <script src="app.js"></script>
    <script>
```

---

现在，我们已经成功实现了系统的数据导入导出和备份恢复功能。总结一下实现的内容：

1. 创建了backup-restore.js文件，实现了数据导出和导入的核心功能
2. 在系统设置页面添加了数据备份与恢复的UI组件
3. 在app.js中添加了对备份恢复功能的初始化调用
4. 在index.html中添加了backup-restore.js的脚本引用

该功能支持以下操作：
1. 导出所有系统数据（包括列车长、申请记录、部门、部门定员和系统设置等）为JSON文件
2. 从备份文件导入系统数据，完全覆盖当前系统中的数据
3. 导入数据后自动刷新页面所有视图，确保数据显示正确

该功能设计符合现代Web应用的最佳实践，提供了友好的用户体验，包括导入状态反馈和导入结果详情展示。

---

_**User**_

备份恢复按钮显示不正确，和背景一个颜色了

---

_**Assistant**_

我看到问题了，备份恢复按钮与背景颜色相同导致显示不正确。我将修改按钮的颜色样式，使其与背景区分开来。

---



---

看起来按钮颜色在HTML中已经设置正确（导出按钮是绿色bg-green-600，导入按钮是蓝色bg-blue-600），但是可能被其他样式覆盖了。让我检查一下按钮的样式问题并尝试另一种方式来修复。

---

<details>
            <summary>Searched codebase "按钮样式或button相关的CSS样式" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `index.html` | L504-545 |
| `src/input.css` | L1-5 |
| `index.html` | L342-364 |
| `application-management.js` | L171-206 |
| `index.html` | L545-574 |
| `index.html` | L25-119 |
| `conductor-list.js` | L147-191 |
| `index.html` | L1108-1128 |
| `tailwind.config.js` | L1-42 |
| `backup-restore.js` | L215-240 |
| `app.js` | L115-140 |
| `index.html` | L951-981 |
| `application-management.js` | L206-237 |
| `index.html` | L417-438 |
| `index.html` | L924-951 |
| `index.html` | L574-614 |
| `settings.js` | L153-188 |
| `app.js` | L140-150 |
| `index.html` | L1012-1032 |
| `index.html` | L271-296 |
| `index.html` | L1070-1108 |
| `index.html` | L364-382 |
| `index.html` | L1032-1070 |
| `index.html` | L438-482 |
| `tailwind-build.md` | L1-45 |

</details>

---

看来按钮本身的样式设置是正确的，但可能有一个渲染或样式优先级的问题。我将尝试修改按钮样式，让它们更加明显，并确保它们不会与背景融合：

---

```diff
                <p class="text-sm text-gray-500">导出当前系统的所有数据，包括部门、列车长和申请记录等</p>
                <div>
-                 <button id="export-backup-btn" class="button bg-green-600 text-white px-4 py-2 rounded-md flex items-center">
+                 <button id="export-backup-btn" class="button bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md flex items-center border border-green-700 shadow-sm">
                    <i class="ri-download-line mr-2"></i> 导出备份数据
                  </button>
```

```diff
                <div>
                  <input type="file" id="import-file-input" accept=".json" class="hidden">
-                 <button id="import-backup-btn" class="button bg-blue-600 text-white px-4 py-2 rounded-md flex items-center">
+                 <button id="import-backup-btn" class="button bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center border border-blue-700 shadow-sm">
                    <i class="ri-upload-line mr-2"></i> 导入备份数据
                  </button>
```

---

现在我们已经增强了按钮的样式，通过：

1. 添加了边框 `border border-green-700` 和 `border border-blue-700`
2. 添加了阴影效果 `shadow-sm`
3. 增加了悬停颜色变化 `hover:bg-green-700` 和 `hover:bg-blue-700`

这些改动应该能让按钮更加明显，不会与背景融合。按钮现在有更强的视觉层次感，更容易被识别和点击。

如果问题仍然存在，可能需要检查按钮上是否有任何其他样式覆盖或Tailwind CSS配置问题。如果继续有问题，请告诉我，我可以尝试更多解决方案，比如完全改变按钮的颜色方案或添加更明显的视觉元素。

---

_**User**_

导入导出按钮能看见了，但是看不见字

---

_**Assistant**_

看起来导入导出按钮能看见了，但是按钮上的文字看不见。这可能是文字颜色和背景色对比度不够造成的问题。我来修改按钮的文字颜色，增强对比度。

---

```diff
                <p class="text-sm text-gray-500">导出当前系统的所有数据，包括部门、列车长和申请记录等</p>
                <div>
-                 <button id="export-backup-btn" class="button bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md flex items-center border border-green-700 shadow-sm">
+                 <button id="export-backup-btn" class="button bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md flex items-center border border-green-700 shadow-sm font-medium">
                    <i class="ri-download-line mr-2"></i> 导出备份数据
                  </button>
```

```diff
                <div>
                  <input type="file" id="import-file-input" accept=".json" class="hidden">
-                 <button id="import-backup-btn" class="button bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center border border-blue-700 shadow-sm">
+                 <button id="import-backup-btn" class="button bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center border border-blue-700 shadow-sm font-medium">
                    <i class="ri-upload-line mr-2"></i> 导入备份数据
                  </button>
```

---

我已经对按钮样式进行了调整，增加了`font-medium`属性使文字变得更粗更明显。如果这个修改后还是看不清文字，可能是颜色对比度问题，我们可以尝试一个更彻底的解决方案：

---

```diff
                <p class="text-sm text-gray-500">导出当前系统的所有数据，包括部门、列车长和申请记录等</p>
                <div>
-                 <button id="export-backup-btn" class="button bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md flex items-center border border-green-700 shadow-sm font-medium">
-                   <i class="ri-download-line mr-2"></i> 导出备份数据
+                 <button id="export-backup-btn" class="button bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md flex items-center border border-green-700 shadow-sm font-medium text-shadow">
+                   <i class="ri-download-line mr-2"></i> <span class="text-[15px]">导出备份数据</span>
                  </button>
                </div>
```

```diff
                <div>
                  <input type="file" id="import-file-input" accept=".json" class="hidden">
-                 <button id="import-backup-btn" class="button bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center border border-blue-700 shadow-sm font-medium">
-                   <i class="ri-upload-line mr-2"></i> 导入备份数据
+                 <button id="import-backup-btn" class="button bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center border border-blue-700 shadow-sm font-medium text-shadow">
+                   <i class="ri-upload-line mr-2"></i> <span class="text-[15px]">导入备份数据</span>
                  </button>
                </div>
```

---

我需要添加一个文本阴影的CSS样式，使文字更加清晰可见：

---

```diff
        padding-right: 30px;
      }
+     
+     .text-shadow {
+       text-shadow: 0px 1px 2px rgba(0, 0, 0, 0.5);
+     }
    </style>
  </head>
```

---

现在我们对导入导出按钮做了以下改进：

1. 增加了`font-medium`样式使文字变粗
2. 增加了文字大小到15px，使文字更明显
3. 添加了文字阴影效果，增强了文字与背景色的对比度
4. 使用了`<span>`元素包裹文字，进一步增强渲染效果

这些修改应该能使按钮文字更加清晰可见。如果仍有问题，我们可以进一步尝试其他方案，比如改变按钮的背景颜色为更明亮的颜色，或者增加文字的描边效果。

---

