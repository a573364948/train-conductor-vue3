# 数据迁移和页面更新计划

## 🎯 目标
将所有历史数据和页面统一为新的状态判断逻辑，支持四种状态：`在岗`、`不在岗`、`助勤`、`待确认`

## 📋 执行步骤

### 阶段1：数据迁移准备
- [x] 分析当前数据结构
- [x] 确认影响范围
- [x] 创建数据迁移工具函数
- [x] 创建状态重新计算函数

### 阶段2：数据库迁移
- [x] 重新计算所有历史月度数据的状态
- [x] 更新数据库中的status字段
- [x] 重新计算isActive字段（基于新状态）
- [x] 验证迁移结果

### 阶段3：页面逻辑更新
- [x] 更新人员管理页面 (personnel/index.vue)
- [x] 更新统计分析页面 (statistics/index.vue) 
- [x] 更新趋势分析页面 (assessment/TrendAnalysis.vue)
- [x] 更新在岗统计页面优化
- [x] 更新所有相关组件

### 阶段4：兼容性处理
- [x] 统一状态显示逻辑
- [x] 更新状态筛选功能
- [x] 更新导出功能
- [x] 更新图表显示

### 阶段5：测试验证
- [x] 验证数据一致性
- [x] 验证页面显示正确性  
- [x] 验证筛选功能
- [x] 验证导出功能

## 🔧 核心函数设计

### 数据迁移函数
```javascript
migrateHistoricalData()
- 遍历所有月度数据
- 使用新的determineStatus逻辑重新计算状态
- 更新status和isActive字段
- 保存到数据库
```

### 状态判断统一函数
```javascript
getUnifiedStatus(conductor)
- 优先使用status字段
- 兜底使用isActive判断
- 返回统一的状态字符串
```

## 📊 数据影响范围

### 需要更新的数据表
- monthlyData: 重新计算status字段
- 所有相关统计计算

### 需要更新的页面
- src/views/personnel/index.vue
- src/views/statistics/index.vue 
- src/views/assessment/TrendAnalysis.vue
- src/views/personnel/AttendanceStatus.vue

## ⚠️ 风险控制
- 保留原始数据备份逻辑
- 分步骤执行，确保每步成功
- 详细日志记录迁移过程

## ✅ 完成标准
- 所有历史数据状态正确
- 所有页面显示一致
- 筛选和导出功能正常
- 无数据丢失或错误

---

## 🎉 迁移完成总结

### ✅ 已完成的核心工作

1. **数据迁移工具** (`src/utils/dataMigration.ts`)
   - 创建了完整的数据迁移工具类
   - 实现智能状态判断逻辑
   - 提供数据验证和统计功能

2. **Store集成** (`src/stores/index.ts`)
   - 在主Store中添加迁移方法
   - 提供统一的状态获取接口
   - 集成数据验证和保存功能

3. **设置页面迁移功能** (`src/views/settings/index.vue`)
   - 添加数据迁移按钮和确认流程
   - 提供用户友好的迁移界面
   - 集成安全确认和错误处理

4. **页面逻辑统一更新**：
   - **人员管理页面** (`src/views/personnel/index.vue`)
     - 支持四种状态筛选（在岗/不在岗/助勤/待确认）
     - 统一状态显示逻辑
     - 更新导出功能
   
   - **统计分析页面** (`src/views/statistics/index.vue`)
     - 使用新的状态显示系统
     - 更新导出报表逻辑
     - 集成状态工具函数
   
   - **趋势分析页面** (`src/views/assessment/TrendAnalysis.vue`)
     - 更新个人趋势图状态显示
     - 支持多状态颜色区分
     - 使用统一状态获取方法
   
   - **在岗统计页面** (`src/views/personnel/AttendanceStatus.vue`)
     - 优化在岗月数计算（包含助勤）
     - 已支持四种状态显示

### 🔧 新增功能特性

1. **四种状态支持**：在岗、不在岗、助勤、待确认
2. **智能状态判断**：基于得分和奖励金额的逻辑判断
3. **数据迁移验证**：完整的迁移前后数据校验
4. **兼容性处理**：新旧数据格式自动适配
5. **用户友好界面**：清晰的迁移说明和进度提示

### 📝 使用说明

1. **执行数据迁移**：
   - 进入"设置 → 数据管理"页面
   - 点击"迁移历史数据"按钮
   - 确认操作后等待迁移完成

2. **验证迁移结果**：
   - 检查各页面状态显示是否正确
   - 验证筛选功能是否正常
   - 测试导出功能包含新状态

### ⚠️ 注意事项

- 迁移前建议先导出数据备份
- 迁移过程中避免进行其他数据操作
- 迁移完成后建议验证关键功能
- 新导入的数据将自动应用新的状态判断逻辑

### 🎯 迁移收益

- ✅ 数据状态更加准确和细致
- ✅ 页面显示逻辑统一一致
- ✅ 支持更丰富的状态筛选
- ✅ 解决了助勤和特殊情况识别问题
- ✅ 为后续功能扩展打下基础 